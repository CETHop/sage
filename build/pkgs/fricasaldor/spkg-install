#!/bin/sh

check_error() {
    if [ $? -ne 0 ]; then
	echo "***********************************************************"
        echo $1
	echo "***********************************************************"
        exit 1
    fi
}
# out-of-source build
if [ -f "$SAGE_ROOT/local/bin/clisp.bin" ]; then
  sed 's/ \$@/ "\$@"/' < $SAGE_ROOT/local/bin/clisp > clisp
  chmod a+rx clisp
  FRICAS_CLISP=`pwd`/clisp
else
  FRICAS_CLISP=clisp
fi
mkdir build-dir
cd build-dir
../src/configure --prefix=$SAGE_LOCAL --without-x --with-lisp="$FRICAS_CLISP" --with-lisp-flavor=clisp
check_error "Failed to configure Axiom."
make
check_error "Failed to make Axiom."
# also install asq
#cp target/*/bin/asq $SAGE_LOCAL/bin && make install
make install
check_error "Failed to install Axiom."
# force 'axiom' script to call AXIOMsys
sed 's/sman \$otheropts -ws \$serverws/AXIOMsys/' < $SAGE_LOCAL/bin/axiom > tmpaxiom && mv tmpaxiom $SAGE_LOCAL/bin/axiom
chmod a+x $SAGE_LOCAL/bin/axiom
check_error "Failed to patch Axiom."

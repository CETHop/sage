#!/usr/bin/env bash

# WARNING -- if you add a package here, also add it to
# the gap_reset_workspace() command in
#    <SAGE_ROOT>/devel/sage/sage/interfaces/gap.py
#

if [ -z "$SAGE_LOCAL" ]; then
    echo >&2 "SAGE_LOCAL undefined ... exiting"
    echo >&2 "Maybe run 'sage --sh'?"
    exit 1
fi

GAP=`echo 'Print(Concatenation("gap-", GAPInfo.Version));' | gap -q`
if [ -z "$GAP" ]; then
    echo >&2 "Error determining the version of GAP installed in Sage."
    exit 1
fi
# GAP should now be set to installed gap version - eg, GAP=gap-4.4.12


rm -rf "$SAGE_ROOT/local/lib/$GAP/pkg/"
mkdir "$SAGE_ROOT/local/lib/$GAP/pkg/"

$CP -p SPKG.txt "$SAGE_ROOT/local/lib/$GAP/pkg/"
if [ $? -ne 0 ]; then
    echo >&2 "Error copying SPKG.txt"
    exit 1
fi


cd src/

# HAPprime should be added in the future?
for p in braid crime ctbllib design factint GAPDoc grape guava Hap HAPcryst laguna polymaking sonata toric
do
    echo "Copying $p package"
    $CP -pr $p "$SAGE_ROOT/local/lib/$GAP/pkg/"
    if [ $? -ne 0 ]; then
        echo >&2 "Error copying $p package."
        exit 1
    fi
done


# Build GRAPE package
cd "$SAGE_ROOT/local/lib/$GAP/pkg/grape/"
rm -rf bin   # added since rebuilding breaks otherwise

./configure ../..
if [ $? -ne 0 ]; then
    echo >&2 "Error configuring GRAPE package."
    exit 1
fi
$MAKE
if [ $? -ne 0 ]; then
    echo >&2 "Error building GRAPE package."
    exit 1
fi


# Build GUAVA package
cd "$SAGE_ROOT/local/lib/$GAP/pkg/guava/"
./configure ../../ --enable-libsuffix=64
if [ $? -ne 0 ]; then
    echo >&2 "Error configuring GUAVA packagae."
    exit 1
fi
$MAKE
if [ $? -ne 0 ]; then
    echo >&2 "Error building GUAVA package."
    exit 1
fi


touch "$SAGE_LOCAL"/bin/gap_stamp
